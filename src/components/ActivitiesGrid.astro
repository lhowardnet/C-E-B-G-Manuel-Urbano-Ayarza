---
import { Icon } from "astro-icon/components";

interface Post {
  id: string;
  timestamp: string;
  permalink: string;
  mediaType: string;
  isReel: boolean;
  mediaUrl: string;
  thumbnailUrl: string;
  caption: string;
}

// Fetch posts from Instagram API
let activities: Post[] = [];
let error: string | null = null;

try {
  const response = await fetch("https://feeds.behold.so/MfLk7E1RITtwXD9TMfI4");
  if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
  const data = await response.json();
  activities = Array.isArray(data.posts) ? data.posts : [];
  console.log(`Loaded ${activities.length} posts from Instagram API`);
} catch (err) {
  error = "Error cargando los posts de Instagram";
  console.error(err);
}

const formatDate = (timestamp: string) => {
  const date = new Date(timestamp);
  return date.toLocaleDateString("es-ES", {
    day: "numeric",
    month: "short",
    year: "numeric",
  });
};
---

{error && (
  <div class="flex items-center justify-center w-full h-96">
    <p class="text-red-500 text-lg">{error}</p>
  </div>
)}

{!error && activities.length > 0 && (
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 w-full px-4">
    {activities.map((post) => (
      <a
        href={post.permalink}
        target="_blank"
        rel="noopener noreferrer"
        class="group relative h-64 rounded-2xl overflow-hidden cursor-pointer border-2 border-purple-300/50 hover:border-purple-400 transition block"
      >
        {/* Background Image - usar thumbnail para videos, mediaUrl para im√°genes */}
        <div
          class="absolute inset-0 bg-cover bg-center transition group-hover:scale-105"
          style={`background-image: url('${post.mediaType === "VIDEO" ? post.thumbnailUrl : post.mediaUrl}')`}
        />

        {/* Overlay oscuro en hover para videos */}
        {post.mediaType === "VIDEO" && (
          <div class="absolute inset-0 bg-black/0 group-hover:bg-black/40 transition-all duration-300 flex items-center justify-center">
            <svg
              class="w-16 h-16 text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300"
              fill="currentColor"
              viewBox="0 0 24 24"
            >
              <path d="M8 5v14l11-7z" />
            </svg>
          </div>
        )}

        {/* Gradient Overlay */}
        <div class="absolute inset-0 bg-gradient-to-b from-transparent via-transparent to-black/70" />

        {/* Badge - Top Left */}
        <div class="absolute top-3 left-3 flex items-center gap-1 px-3 py-1 rounded-full bg-yellow-400 text-white text-sm font-semibold">
          <Icon name="lucide:play-circle" class="w-4 h-4" />
          {post.isReel ? "Reel" : post.mediaType}
        </div>

        {/* Content - Bottom */}
        <div class="absolute bottom-0 left-0 right-0 p-4 flex flex-col gap-2">
          <h3 class="text-white font-bold text-lg leading-tight line-clamp-2">
            {post.caption || "Actividad"}
          </h3>
          <div class="flex items-center gap-2">
            <span class="bg-yellow-400 text-primary-950 font-bold px-3 py-1 rounded-full text-sm">
              {formatDate(post.timestamp)}
            </span>
          </div>
        </div>
      </a>
    ))}
  </div>
)}

{!error && activities.length === 0 && (
  <div class="flex items-center justify-center w-full h-96">
    <p class="text-gray-400 text-lg">No hay actividades para mostrar</p>
  </div>
)}
